<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PRO Multi-Pane WebTrader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --bg: #181a20; --panel: #20222b; --accent: #199cf4; --border-focus: #36e8b7; --text: #eee; }
    html, body {height:100%;margin:0;padding:0;}
    body {background:var(--bg);color:var(--text);font-family:'Segoe UI',Arial,sans-serif;}
    .layout{display:flex;height:100vh;}
    .main{flex:1;display:flex;flex-direction:column;}
    .topbar{display:flex;align-items:center;gap:22px;padding:14px 18px 8px 22px;background:var(--panel);}
    .app-title{font-size:20px;font-weight:600;}
    .layout-switch{margin-left:auto;}
    .layout-btn{background:var(--bg);border:1px solid #222;color:var(--accent);padding:5px 14px;border-radius:7px;font-size:16px;margin-left:8px;cursor:pointer;}
    .layout-btn.active{background:var(--accent);color:#fff;}
    .syncbox{margin-left:22px;}
    .panegrid{flex:1;display:grid;gap:4px;background:var(--bg);}
    .pane-focus{border:2.5px solid var(--border-focus);}
    .pane{border:2.5px solid #222;background:var(--panel);overflow:hidden;position:relative;}
    .pane-controls{position:absolute;top:7px;right:8px;z-index:9;display:flex;gap:7px;}
    .set-symbol-inp{font-size:14px;padding:1.5px 7px;border-radius:5px;border:1px solid #333;background:#222;color:#fff;min-width:75px;}
    .pane-label{position:absolute;left:9px;top:6px;font-size:14px;z-index:99;background:var(--panel);color:#82b6fe;padding:3px 9px;border-radius:7px;cursor:grab;}
    .pane-label.dragging{opacity:0.6;background:#111;}
    .alerts-ui{position:absolute;bottom:7px;left:9px;right:9px;z-index:14;background:rgba(40,50,80,0.87);border-radius:7px;padding:7px;display:none;}
    .pane-alerts-btn{background:#181c27;border:1px solid #2a3340;color:var(--accent);border-radius:5px;font-size:15px;cursor:pointer;padding:2px 7px;}
    .alerts-ui.active{display:block;}
    .alerts-list{max-height:52px;overflow:auto;font-size:13px;margin-bottom:5px;}
    .alert-item{display:flex;align-items:center;justify-content:space-between;margin-bottom:2px;}
    .alert-remove{background:none;border:none;font-size:17px;color:#f96a6a;cursor:pointer;}
    .alert-addbox{display:flex;gap:5px;margin-top:2px;}
    .alert-addbox input{width:70px;font-size:13px;border-radius:5px;padding:0 5px 0 4px;}
    /* NEW: Rightbar group - watchlist over alerts */
    .rightbar{background:var(--panel);width:242px;min-width:150px;max-width:270px;border-left:2.5px solid #191a1f;display:flex;flex-direction:column;height:100%;padding:0;box-shadow:-5px 0 12px #161a2066;}
    .watchlist-top{display:flex;align-items:center;justify-content:space-between;padding:8px 10px 3px 15px;}
    .wl-title{font-size:16px;font-weight:700;}
    .wl-dotbtn{background:none;border:none;font-size:22px;color:var(--accent);cursor:pointer;margin-left:7px;}
    .watchlisttabs{display:flex;gap:5px;padding:0 10px 6px;}
    .watchlist-tab{background:var(--panel);border:none;color:#999;padding:3px 10px;border-radius:6px;cursor:pointer;font-size:13px;}
    .watchlist-tab.active,.watchlist-tab:hover{background:var(--accent);color:#fff;}
    .wl-menu-popup{position:absolute;top:38px;right:24px;background:#242b36;border-radius:9px;box-shadow:0 7px 24px #111a2f77;z-index:21;width:170px;}
    .wl-menu-popup button{display:block;width:100%;padding:10px;text-align:left;background:none;border:none;color:#eee;font-size:15px;cursor:pointer;}
    .wl-menu-popup button:hover{background:#223352;}
    .watchlist-list{flex:1;overflow-y:auto;padding:0 4px 2px 10px;}
    .watch-item{display:flex;align-items:center;justify-content:space-between;padding:7px 0 7px 9px;cursor:pointer;border-bottom:1px solid #26282f;}
    .watch-item span{flex:1;}
    .watch-item.active{background-color:#292f44;}
    .watch-item:hover{color:var(--accent);background:rgba(31,44,99,0.14);}
    .add-watch-inp{margin:7px 10px 12px 14px;padding:4px 9px;border-radius:7px;border:1px solid #26282f;background:#232b38;color:#fff;}
    .rembtn{font-size:16px;color:#f96a6a;background:none;border:none;margin-left:8px;cursor:pointer;padding:2px;}
    .alertbar{border-top:1.5px solid #252732;padding:12px 11px 5px 16px;}
    .alert-label{font-weight:600;font-size:15px;}
    .alertbar-list{font-size:14px;max-height:77px;overflow-x:hidden;overflow-y:auto;}
    .alertbar-item{color:var(--text);margin:1px 0;}
    .alertbar-remove{color:#f96a6a;font-size:16px;background:none;border:none;margin-left:7px;}
    /* ALERT MODAL */
    .alert-modal {
      position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:99;
      display:none;align-items:center;justify-content:center;
    }
    .alert-modal-content {
      background:#1c222f;border-radius:13px;padding:25px 30px 22px 30px;box-shadow:0 12px 30px #000c;padding-top:20px;width:350px;text-align:center;
    }
    .alert-modal-content label {display:block;text-align:left;margin:10px 0 8px 5px;}
    @media (max-width:900px){.rightbar{display:none;}}
    @media (max-width:700px){.pane{border-width:1.5px;}}
  </style>
</head>
<body>
<div class="layout">
  <div class="main">
    <div class="topbar">
      <span class="app-title">PRO Multi-Pane WebTrader</span>
      <div class="syncbox">
        <label style="font-size:15px"><input type="checkbox" id="syncOn" onchange="toggleSync()" style="margin:0 4px 0 0;">Sync All Charts</label>
      </div>
      <div class="layout-switch">
        <button class="layout-btn" id="btn1" onclick="setScreens(1)">1</button>
        <button class="layout-btn" id="btn2" onclick="setScreens(2)">2</button>
        <button class="layout-btn" id="btn2v" onclick="setScreens('2v')">2V</button>
        <button class="layout-btn" id="btn4" onclick="setScreens(4)">4</button>
      </div>
    </div>
    <div id="panegrid" class="panegrid"></div>
  </div>
  <div class="rightbar" id="rightbar">
    <div class="watchlist-top">
      <span class="wl-title">Watchlist</span>
      <button class="wl-dotbtn" onclick="toggleWatchlistMenu()">â‹®</button>
      <div id="wlMenuPopup" class="wl-menu-popup" style="display:none;">
        <button onclick="addWatchlist()">Create New Watchlist</button>
        <button onclick="promptAddSymbol()">Add Symbol</button>
        <button onclick="renameWatchlist()">Rename Watchlist</button>
        <button onclick="importWatchlist()">Import List</button>
      </div>
    </div>
    <div class="watchlisttabs" id="watchlistTabs"></div>
    <div class="watchlist-list" id="watchlistDiv"></div>
    <input id="addWatchInp" class="add-watch-inp" placeholder="Add symbol..." onkeydown="if(event.key==='Enter')addToWatchlist()" />
    <div class="alertbar">
      <div class="alert-label">My Alerts</div>
      <div class="alertbar-list" id="rightAlertList"></div>
    </div>
  </div>
</div>

<!-- ALERT MODAL DIALOG -->
<div class="alert-modal" id="alertModal">
  <div class="alert-modal-content">
    <h2>Set Price Alert</h2>
    <label>Alert when price:</label>
    <select id="alertDir">
      <option value="above">Crosses ABOVE</option>
      <option value="below">Crosses BELOW</option>
    </select>
    <label>Price:</label>
    <input id="alertModalPrice" type="number" style="width:140px;font-size:17px;margin-bottom:15px;">
    <br>
    <button onclick="saveModalAlert()">Set Alert</button>
    <button onclick="closeAlertModal()" style="margin-left:14px;">Cancel</button>
  </div>
</div>

<script>
let watchlists = JSON.parse(localStorage.getItem('multiwatchlists')||'null') || {
  "Forex": ["EURUSD", "GBPUSD"],
  "Crypto": ["BTCUSDT", "ETHUSDT"],
  "Stocks": ["AAPL", "TSLA"]
};
let watchlistNames = Object.keys(watchlists);
let currentWatchlist = localStorage.getItem('currentWatchlist') || watchlistNames[0];
function saveWatchlists(){ localStorage.setItem('multiwatchlists',JSON.stringify(watchlists)); }
function saveCurrentWatchlist(){ localStorage.setItem('currentWatchlist',currentWatchlist); }
function renderWatchlistTabs(){
  let wtab = document.getElementById('watchlistTabs'); wtab.innerHTML = '';
  Object.keys(watchlists).forEach((wl, idx)=>{
    let btn = document.createElement('button');
    btn.className='watchlist-tab'+(wl===currentWatchlist?' active':'');
    btn.textContent=wl; btn.onclick=()=>{currentWatchlist=wl;saveCurrentWatchlist();renderWatchlistTabs();renderWatchlist();};
    wtab.appendChild(btn);
  });
}
function addWatchlist() {
  let name=prompt("Watchlist name:"); if(!name||watchlists[name])return;
  watchlists[name]=[]; currentWatchlist=name; saveWatchlists(); saveCurrentWatchlist(); toggleWatchlistMenu(false); renderWatchlistTabs(); renderWatchlist();
}
function renameWatchlist() {
  let nwl = prompt("Rename current watchlist", currentWatchlist);
  if(!nwl||watchlists[nwl])return;
  watchlists[nwl]=watchlists[currentWatchlist];
  delete watchlists[currentWatchlist];
  currentWatchlist = nwl; saveWatchlists(); saveCurrentWatchlist(); toggleWatchlistMenu(false); renderWatchlistTabs(); renderWatchlist();
}
function importWatchlist(){
  let data = prompt("Paste comma/space/line separated symbol list:");
  if(!data) return;
  let arr = data.replace(/[\s,]+/g,",").split(",");
  watchlists[currentWatchlist] = arr.filter(x=>x&&x.length>=3).map(x=>x.toUpperCase());
  saveWatchlists(); renderWatchlist();
  toggleWatchlistMenu(false);
}
function toggleWatchlistMenu(force) {
  let el = document.getElementById('wlMenuPopup');
  if(force===false){el.style.display="none"; return;}
  el.style.display = (el.style.display==="none"||!el.style.display)?"block":"none";
  setTimeout(()=>{window.onclick=function(e){
    if(!el.contains(e.target) && e.target.className!=="wl-dotbtn"){el.style.display="none";window.onclick=null;}
  }},100);
}
function promptAddSymbol(){toggleWatchlistMenu(false);document.getElementById('addWatchInp').focus();}
function renderWatchlist(){
  let arr = watchlists[currentWatchlist]; let wdiv = document.getElementById('watchlistDiv'); wdiv.innerHTML='';
  arr.forEach((sym,idx)=>{
    let el = document.createElement('div');
    el.className = 'watch-item';
    el.innerHTML = `<span>${sym}</span><button class="rembtn" onclick="event.stopPropagation();removeFromWatch(${idx})">&times;</button>`;
    el.onclick = ()=>applySymbolToActivePane(sym);
    wdiv.appendChild(el);
  });
}
function addToWatchlist(){
  let v = document.getElementById('addWatchInp').value.trim().toUpperCase();
  if(!v||watchlists[currentWatchlist].includes(v))return;
  watchlists[currentWatchlist].push(v); saveWatchlists(); renderWatchlist(); document.getElementById('addWatchInp').value='';
}
function removeFromWatch(idx){
  watchlists[currentWatchlist].splice(idx,1); saveWatchlists(); renderWatchlist();
}

// ---- Multi-pane + alerts/sync/drag as before ----
let paneLayout = localStorage.getItem('paneset')||'1';
let paneSyms = JSON.parse(localStorage.getItem('panesyms')||'null')||[watchlists[currentWatchlist][0]||"EURUSD"];
let paneIntervals = JSON.parse(localStorage.getItem('paneints')||'null')||["15","15","15","15"];
let alertsPerPane = JSON.parse(localStorage.getItem('alertsPerPane')||'null')||[[],[],[],[]];
let activePane = 0;
let syncMode = localStorage.getItem('syncOn')=="1";
document.getElementById("syncOn").checked=syncMode;

function setScreens(n){
  paneLayout = n; localStorage.setItem('paneset',n);
  let wlarr = watchlists[currentWatchlist];
  let defaultSyms = wlarr.concat(["EURUSD","BTCUSDT","ETHUSDT"]).slice(0,4);
  if(typeof n==="number"||n==="4") n=Number(n);
  if(n===1) {paneSyms = [paneSyms[activePane]||defaultSyms]; paneIntervals=["15"];}
  else if(n===2) {paneSyms = [paneSyms||defaultSyms, paneSyms[1]||defaultSyms[1]]; paneIntervals=["15","15"];}
  else if(n==="2v") {paneSyms = [paneSyms||defaultSyms, paneSyms[1]||defaultSyms[1]]; paneIntervals=["15","15"];}
  else if(n===4||n==="4") {paneSyms = [
    paneSyms||defaultSyms, paneSyms[1]||defaultSyms[1],
    paneSyms||defaultSyms, paneSyms||defaultSyms
  ]; paneIntervals=["15","15","15","15"];}
  alertsPerPane.length = paneSyms.length;
  for(let i=0;i<alertsPerPane.length;i++) alertsPerPane[i]=alertsPerPane[i]||[];
  activePane=0; savePanes(); renderPanes();
}
function savePanes(){
  localStorage.setItem('panesyms',JSON.stringify(paneSyms));
  localStorage.setItem('paneints',JSON.stringify(paneIntervals));
  localStorage.setItem('alertsPerPane',JSON.stringify(alertsPerPane));
  localStorage.setItem('syncOn',syncMode?"1":"0");
}
function renderPanes(){
  renderWatchlistTabs(); renderWatchlist(); renderAlertsRightBar();
  ["btn1","btn2","btn2v","btn4"].forEach(id=>{
    let b=document.getElementById(id); if(b) b.classList.remove("active");
  });
  if(paneLayout===1||paneLayout==="1")document.getElementById("btn1").classList.add("active");
  if(paneLayout===2||paneLayout==="2")document.getElementById("btn2").classList.add("active");
  if(paneLayout==="2v")document.getElementById("btn2v").classList.add("active");
  if(paneLayout===4||paneLayout==="4")document.getElementById("btn4").classList.add("active");
  let grid = document.getElementById('panegrid'); let layout=String(paneLayout); let n = layout==="2v" ? 2 : Number(layout);
  grid.style.gridTemplateColumns = layout==="2v" ? "1fr 1fr" : (n>1?"1fr 1fr":"1fr");
  grid.style.gridTemplateRows = (layout==="4") ? "1fr 1fr" : "1fr"; grid.innerHTML = '';
  let count = (layout==="4") ? 4 : n;
  for(let i=0;i<count;i++){
    let pane = document.createElement('div');
    pane.className='pane'+(i===activePane?' pane-focus':'');
    pane.ondragover = ev => {ev.preventDefault(); pane.style.outline="2.5px solid var(--accent)";}
    pane.ondragleave = () => pane.style.outline="";
    pane.ondrop = ev => {
      ev.preventDefault(); pane.style.outline="";
      let from = Number(ev.dataTransfer.getData("frompane"));
      let tempSym = paneSyms[from], tempInt = paneIntervals[from], tempAl = alertsPerPane[from];
      paneSyms[from]=paneSyms[i]; paneIntervals[from]=paneIntervals[i]; alertsPerPane[from] = alertsPerPane[i];
      paneSyms[i]=tempSym; paneIntervals[i]=tempInt; alertsPerPane[i]=tempAl;
      savePanes(); renderPanes();
    };
    pane.onclick = ()=>{activePane=i; renderPanes();};
    // DRAGGABLE LABEL
    let label = document.createElement('div'); label.className='pane-label'; label.textContent=paneSyms[i]||"";
    label.draggable=true;
    label.ondragstart = ev=> { ev.dataTransfer.setData("frompane",i); label.classList.add("dragging"); };
    label.ondragend = ()=> label.classList.remove("dragging");
    pane.appendChild(label);
    // CONTROLS
    let cwrap = document.createElement('div'); cwrap.className='pane-controls';
    let inp = document.createElement('input');
    inp.type="text"; inp.value=paneSyms[i]||""; inp.className="set-symbol-inp";
    inp.title="Type symbol and press Enter";
    inp.onkeydown=(e)=>{if(e.key==='Enter'){setPaneSymbol(i,inp.value.toUpperCase());}};
    cwrap.appendChild(inp);
    let sel = document.createElement('select'); sel.className="set-symbol-inp";
    ["1","3","5","15","30","60","D","W"].forEach(_int=>{
      let o=document.createElement('option');o.value=_int;o.text=_int;sel.appendChild(o);
    });
    sel.value=paneIntervals[i]; sel.onchange=()=>setPaneInterval(i,sel.value);
    cwrap.appendChild(sel);
    let abtn = document.createElement('button');
    abtn.className='pane-alerts-btn'; abtn.textContent="ðŸ””";
    abtn.onclick = e => { e.stopPropagation(); openAlertModal(i); };
    cwrap.appendChild(abtn);
    pane.appendChild(cwrap);
    // TV Chart Widget
    let chartDiv = document.createElement('div'); chartDiv.id='tvchart'+i; chartDiv.style.height="calc(100% - 42px)";
    pane.appendChild(chartDiv);
    grid.appendChild(pane);
    setTimeout(()=>loadTVWidget(i, paneSyms[i]||"EURUSD", paneIntervals[i]||"15"),220);
  }
}
function setPaneSymbol(idx, sym){
  paneSyms[idx]=sym; savePanes();
  if(syncMode){ for(let k=0;k<paneSyms.length;k++)paneSyms[k]=sym; }
  renderPanes();
}
function setPaneInterval(idx, _int){
  paneIntervals[idx]=_int; savePanes();
  if(syncMode){ for(let k=0;k<paneIntervals.length;k++)paneIntervals[k]=_int; }
  renderPanes();
}
function applySymbolToActivePane(sym){
  paneSyms[activePane]=sym; savePanes(); if(syncMode){ for(let k=0;k<paneSyms.length;k++)paneSyms[k]=sym; } renderPanes();
}
function toggleSync(){ syncMode = document.getElementById("syncOn").checked; savePanes(); renderPanes(); }
let modalPaneIdx = 0;
function openAlertModal(idx){
  modalPaneIdx = idx;
  document.getElementById("alertModalPrice").value = "";
  document.getElementById("alertModal").style.display = "flex";
}
function closeAlertModal(){
  document.getElementById("alertModal").style.display = "none";
}
function saveModalAlert(){
  let price = parseFloat(document.getElementById("alertModalPrice").value);
  let dir = document.getElementById("alertDir").value;
  if(isNaN(price)) return alert("Please enter a price!");
  if(!alertsPerPane[modalPaneIdx]) alertsPerPane[modalPaneIdx]=[];
  alertsPerPane[modalPaneIdx].push({type:"abovebelow", dir:dir, price:price});
  closeAlertModal(); savePanes(); renderPanes();
}
function renderAlertsRightBar(){
  let list = document.getElementById('rightAlertList');
  list.innerHTML = '';
  (alertsPerPane[activePane]||[]).forEach((alrt, idx)=>{
    let txt = typeof alrt === "number"
      ? `${paneSyms[activePane]}: ${alrt}` 
      : `${paneSyms[activePane]}: ${alrt.dir === "above" ? "Above" : "Below"} ${alrt.price}`;
    let div = document.createElement('div');
    div.className='alertbar-item';
    div.textContent = txt;
    let x = document.createElement('button');
    x.className="alertbar-remove"; x.textContent="Ã—";
    x.onclick=()=>{alertsPerPane[activePane].splice(idx,1);savePanes();renderPanes();};
    div.appendChild(x); list.appendChild(div);
  });
}
function toggleAlertsPanel(idx){
  alertsPerPane.forEach((_,i)=>{alertsPerPane[i].open=(i===idx ? !(alertsPerPane[i].open||false):false);});
  renderPanes();
}
function loadTVWidget(idx, sym, _int){
  let eid = 'tvchart'+idx;
  function createChart(){
    new TradingView.widget({
      container_id:eid,width:"100%",height:"99%",symbol:sym,interval:_int,timezone:"Etc/UTC",theme:"dark",style:"1",locale:"en",
      toolbar_bg:"#181a1f",enable_publishing:false,allow_symbol_change:false,details:true,calendar:true,studies:[],hide_side_toolbar:false,withdateranges:true
    });
  }
  if (typeof window.TradingView === "undefined") {
    if (!window._tvjsLoading) {
      window._tvjsLoading = true;
      let script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = 'https://s3.tradingview.com/tv.js';
      script.onload = function(){ window._tvjsLoading = false; createChart(); };
      script.onerror = function(){
        alert("TradingView chart library failed to load. Please check your internet connection.");
      };
      document.body.appendChild(script);
    } else {
      setTimeout(()=>loadTVWidget(idx, sym, _int), 250);
    }
  } else {
    createChart();
  }
}

// --- Alerts checker per pane ---
setInterval(async ()=>{
  for(let i=0;i<paneSyms.length;i++){
    let arr=(alertsPerPane[i]||[]);
    if(!arr.length)continue;
    let sym=paneSyms[i],p=null,url=null;
    if(/USD|USDT|BTC|ETH/.test(sym))
      url=`https://api.binance.com/api/v3/ticker/price?symbol=${sym}`;
    else if(/^[A-Z]{6}$/i.test(sym))
      url=`https://api.exchangerate.host/latest?base=${sym.substring(0,3)}&symbols=${sym.substring(3,6)}`;
    else continue;
    try{let res=await fetch(url);let data=await res.json();p=(data.price)?parseFloat(data.price):(data.rates?sym.substring(3,6):null);}catch{}
    if(!p)continue;
    arr.forEach((alrt,idx)=>{
      if(typeof alrt === "number") return;
      if((alrt.dir==="above"&&p>alrt.price)||(alrt.dir==="below"&&p<alrt.price)){
        alert(`${sym} hit alert: ${alrt.dir==="above"?"crossed above":"crossed below"} ${alrt.price}, now ${p}`);
        new Audio("https://www.soundjay.com/button/beep-07.wav").play();
        window.speechSynthesis.speak(new SpeechSynthesisUtterance(`${sym} price is ${p}`));
        alertsPerPane[i].splice(idx,1); savePanes(); renderPanes();
      }
    });
  }
},7000);

// -- Render on load
setScreens(paneLayout); renderPanes();
</script>
</body>
</html>
