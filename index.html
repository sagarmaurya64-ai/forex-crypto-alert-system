<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="UTF-8">
  <title>Pro TradingView Alerts (Full Features, Dark Mode)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    <script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js")
    .then(function(reg) {
      console.log("Service worker registered.", reg);
    });
}
</script>
    body {
      font-family: Arial, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #181A20; 
      color: #eee;
    }
    #topbar {
      margin: 0; 
      padding: 18px 16px 10px 16px;
      background: #23252e;
      display: flex; 
      flex-wrap: wrap; 
      gap: 9px; 
      align-items: center;
    }
    input, button {
      padding: 7px; 
      font-size: 1rem; 
      border-radius: 3px;
      border: none;
      margin: 2px 0;
      background: #222;
      color: #eee;
    }
    input { border: 1px solid #333;}
    button {
      background: #2999f4; 
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    button:active { background: #1762a7; }
    #alertlist { margin: 14px 16px 0 16px;}
    .alert-item {
      background: #212634; 
      border: 1px solid #333; 
      border-radius: 5px; 
      padding: 5px 12px; 
      display: inline-block; 
      margin: 5px 5px 0 0;
      color: #36e8b7;
    }
    .remove-btn {
      color: #f96a6a; 
      background: none; 
      border: none; 
      font-size: 18px; 
      vertical-align: top; 
      cursor: pointer;
      margin-left: 5px;
    }
    @media (max-width: 700px) {
      #topbar { flex-direction: column; align-items: start; }
    }
  </style>
</head>
<body>
  <div id="topbar">
    <label>Symbol: 
      <input id="symbol" value="EURUSD" style="width:90px;">
    </label>
    <button onclick="setSymbol()">Load Chart</button>
    <label> Alert price: 
      <input type="number" id="alertPrice" step="any" style="width:85px;">
    </label>
    <button onclick="addAlert()">Add Alert</button>
  </div>
  <div id="alertlist">
    <b>Your Alerts for <span id="currentSymbol" style="color:#f7b731">EURUSD</span>:</b>
    <div id="alertsArea"></div>
  </div>
  <!-- TradingView Advanced Chart Widget BEGIN -->
  <div class="tradingview-widget-container" style="margin:24px 0 0 0;">
    <div id="tradingview_chart" style="height:600px;"></div>
  </div>
  <!-- TradingView Advanced Chart Widget END -->

  <script>
    let currentSymbol = "EURUSD";
    let intervalId = null;
    let alertData = {};
    const priceAPI = {
      forex: (base, quote) => `https://api.exchangerate.host/latest?base=${base}&symbols=${quote}`,
      binance: (sym) => `https://api.binance.com/api/v3/ticker/price?symbol=${sym}`
    };

    function loadStoredAlerts() {
      let saved = localStorage.getItem('alertData');
      if (saved) alertData = JSON.parse(saved);
    }
    function saveStoredAlerts() {
      localStorage.setItem('alertData', JSON.stringify(alertData));
    }
    function renderAlerts() {
      let el = document.getElementById('alertsArea');
      el.innerHTML = '';
      (alertData[currentSymbol] || []).forEach((price, i) => {
        let span = document.createElement('span');
        span.className = 'alert-item';
        span.textContent = price;
        let rm = document.createElement('button');
        rm.textContent = 'Ã—';
        rm.className = 'remove-btn';
        rm.onclick = () => removeAlert(i);
        span.appendChild(rm);
        el.appendChild(span);
      });
    }
    function addAlert() {
      let price = parseFloat(document.getElementById('alertPrice').value);
      if (!price || isNaN(price)) { alert("Enter valid price!"); return; }
      if (!alertData[currentSymbol]) alertData[currentSymbol] = [];
      alertData[currentSymbol].push(price);
      saveStoredAlerts();
      renderAlerts();
      document.getElementById('alertPrice').value = '';
    }
    function removeAlert(idx) {
      alertData[currentSymbol].splice(idx,1);
      saveStoredAlerts();
      renderAlerts();
    }
    function setSymbol() {
      currentSymbol = document.getElementById('symbol').value.toUpperCase();
      document.getElementById('currentSymbol').innerText = currentSymbol;
      renderAlerts();
      document.getElementById('tradingview_chart').innerHTML = '';
      loadChart(currentSymbol);
    }
    async function checkPrice() {
      let sym = currentSymbol;
      let price = null, isCrypto = false, base, quote, url;
      if (sym.endsWith('USDT') || sym.startsWith('BTC') || sym.startsWith('ETH') || sym.startsWith('BNB')) {
        url = priceAPI.binance(sym);
        isCrypto = true;
      } else if (/^[A-Z]{6}$/i.test(sym)) {
        base = sym.slice(0,3);
        quote = sym.slice(3,6);
        url = priceAPI.forex(base, quote);
      } else return;
      try {
        let res = await fetch(url);
        let data = await res.json();
        if (isCrypto) {
          price = parseFloat(data.price);
        } else {
          price = data.rates[quote];
        }
      } catch (e) { price = null; }
      if (!price) return;
      (alertData[currentSymbol] || []).forEach((ap, i) => {
        let diff = Math.abs(price - ap);
        let thresh = price > 100 ? 0.05 : price > 10 ? 0.01 : 0.001;
        if (diff < thresh) {
          alert(`Price alert for ${currentSymbol}: ${price}`);
          new Audio("https://www.soundjay.com/button/beep-07.wav").play();
          window.speechSynthesis.speak(new SpeechSynthesisUtterance(`${currentSymbol} price is ${price}`));
          alertData[currentSymbol].splice(i,1);
          saveStoredAlerts();
          renderAlerts();
        }
      });
    }
    function loadChart(symbol) {
      // Remove existing widget if any
      if (document.getElementById('tradingview-script')) {
        document.getElementById('tradingview-script').remove();
      }
      let script = document.createElement('script');
      script.id = 'tradingview-script';
      script.type = 'text/javascript';
      script.src = 'https://s3.tradingview.com/tv.js';
      document.body.appendChild(script);
      script.onload = function() {
        new TradingView.widget({
          "container_id": "tradingview_chart",
          "width": "100%",
          "height": 600,
          "symbol": symbol,
          "interval": "15",
          "timezone": "Etc/UTC",
          "theme": "dark",
          "style": "1",
          "locale": "en",
          "toolbar_bg": "#23252e",
          "saved_data": false,
          "enable_publishing": false,
          "allow_symbol_change": true,
          "details": true,
          "calendar": true,
          "studies": [],
          "withdateranges": true,
          "hide_side_toolbar": false,
          "show_popup_button": true,
          "popup_width": "1000",
          "popup_height": "650"
        });
      };
    }
    loadStoredAlerts();
    renderAlerts();
    loadChart(currentSymbol);
    if (intervalId) clearInterval(intervalId);
    intervalId = setInterval(checkPrice, 8000);
    document.getElementById('symbol').addEventListener('change',function(){
      currentSymbol = this.value.toUpperCase();
      document.getElementById('currentSymbol').innerText = currentSymbol;
      renderAlerts();
    });
  </script>
</body>
</html>
